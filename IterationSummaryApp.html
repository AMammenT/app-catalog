<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- Copyright (c) 2011  Rally Software Development Corp.  All rights reserved -->
<html>
<head>
    <title>Iteration Summary</title>
    <meta name="Name" content="App: Iteration Summary"/>
    <meta name="Version" content="2011.09.20"/>
    <meta name="Vendor" content="Rally Software"/>
    <script type="text/javascript" src="/apps/1.28/sdk.js"></script>
    <script type="text/javascript">
        var rallyDataSource, iterationDropdown, timeboxOverview;

        function _getMode() {
            if ('__MODE__' !== '__M' + 'ODE__') {
                return '__MODE__';
            } else {
                return 'webtab';
            }
        }

        function iterationSelected(iteration) {
            return iteration && iteration.Name !== undefined && iteration.Name.length > 0;
        }

        function createTimeboxConfig(iteration) {
            return {
                timeboxStartDate: iteration.StartDate.slice(0, 10),
                timeboxEndDate: iteration.EndDate.slice(0, 10),
                timeboxName: iteration.Name,
                timeboxState: iteration.State,
                timeboxRef: iteration._ref
            };
        }

        function onDashboardPageTimeboxFilterChanged(args) {
            if (args.iteration && iterationSelected(args.iteration)) {
                timeboxOverview.refresh(createTimeboxConfig(args.iteration));
            }
        }

        function onLocalTimeboxDropdownChanged(dropdown, args) {
            if (iterationSelected(dropdown.getSelectedItem())) {
                timeboxOverview.refresh(createTimeboxConfig(dropdown.getSelectedItem()));
            }
        }

        function displayTimeboxOverviewFromDropdown(dropdown) {
            displayTimeboxOverviewFromIteration(dropdown.getSelectedItem());
        }

        function displayTimeboxOverviewFromIteration(iteration) {
            if (_getMode() === 'panel') {
                rally.sdk.ui.AppHeader.destroy();
            } else {
                rally.sdk.ui.AppHeader.setHelpUrl('http://www.rallydev.com/help/iteration-summary');
            }

            if (iterationSelected(iteration)) {
                var config = createTimeboxConfig(iteration);
                timeboxOverview = new rally.sdk.app.TimeboxOverview(config, rallyDataSource);
                timeboxOverview.display("timeboxOverview");
            }
        }

        function onLoad() {
            rallyDataSource = new rally.sdk.data.RallyDataSource('__WORKSPACE_OID__',
                    '__PROJECT_OID__',
                    '__PROJECT_SCOPING_UP__',
                    '__PROJECT_SCOPING_DOWN__');

            var panelContext = rally.sdk.util.Context.getPanelContext();
            if (panelContext.timeboxFilter && panelContext.timeboxFilter.iteration !== undefined) {
                displayTimeboxOverviewFromIteration(panelContext.timeboxFilter.iteration);
            } else {
                iterationDropdown = new rally.sdk.ui.IterationDropdown({label: "Iteration: ", fetch: "State"}, rallyDataSource);
                iterationDropdown.addEventListener("onChange", onLocalTimeboxDropdownChanged);
                iterationDropdown.addEventListener("onLoad", displayTimeboxOverviewFromDropdown);
                iterationDropdown.display("dropdown");
            }
        }

        rally.addOnLoad(function() {
            onLoad();
        });


    </script>
</head>
<body>
<div id="dropdown"></div>
<div id="timeboxOverview"></div>
</body>
</html>