<!DOCTYPE html>
<html>
<head>
    <title>Portfolio Kanban Board</title>

    <script type="text/javascript" src="/apps/x/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.portfoliokanban.PortfolioKanbanCard",{extend:"Rally.ui.cardboard.Card",alias:"widget.rallyportfoliokanbancard",inheritableStatics:{getFetchFields:function(){return["Owner","FormattedID","Name","StateChangedDate","Blocked","Ready","DisplayColor"]}},config:{customFieldConfig:{UserStories:{fetch:["UserStories","LeafStoryPlanEstimateTotal","LeafStoryCount"],popoverConfig:{placement:["bottom","right","left","top"],listViewConfig:{addNewConfig:{showAddWithDetails:!1},gridConfig:{columnCfgs:["FormattedID","Name","Release","Iteration",{dataIndex:"ScheduleState",text:"State"},{dataIndex:"PlanEstimate",editor:{decimalPrecision:0}},"Project"]}}}}}},constructor:function(config){config.fields=Ext.Array.union(config.fields||[],["StateChangedDate"]),this.callParent(arguments)}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.portfoliokanban.PortfolioKanbanPolicy",{extend:"Rally.ui.cardboard.PolicyContainer",alias:"widget.rallyportfoliokanbanpolicy",config:{stateRecord:void 0},canEditPolicy:function(){return this.getStateRecord().get("updatable")},getPolicyText:function(){return this.getStateRecord()&&this.getStateRecord().get("Description")},draw:function(){this.getStateRecord()?this.callParent(arguments):this._drawNotApplicable()},_drawNotApplicable:function(){this.add({xtype:"component",renderTpl:'<div class="policyContent">Not Applicable</div>'})},onEditClick:function(){Ext.create("Rally.ui.dialog.RichTextDialog",{title:'Edit the Exit Policy for "'+this.getStateRecord().get("Name")+'" Column',headerItems:[{xtype:"component",cls:"kanbanPolicyRichTextEditorHeader",html:"What needs to be done before an item is ready to leave this column?"}],autoShow:!0,record:this.getStateRecord(),fieldName:"Description",editorMaxHeight:500,listeners:{save:this.drawPolicy,scope:this}})}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.portfoliokanban.PortfolioKanbanApp",{extend:"Rally.app.App",requires:["Rally.apps.portfoliokanban.PortfolioKanbanCard","Rally.apps.portfoliokanban.PortfolioKanbanPolicy","Rally.ui.gridboard.plugin.GridBoardAddNew","Rally.ui.gridboard.plugin.GridBoardFieldPicker","Rally.ui.gridboard.plugin.GridBoardOwnerFilter","Rally.ui.gridboard.plugin.BoardPolicyDisplayable","Rally.ui.filter.view.OwnerPillFilter","Rally.ui.filter.view.TagPillFilter","Rally.ui.gridboard.plugin.GridBoardTagFilter","Rally.ui.gridboard.plugin.GridBoardFilterControl","Rally.ui.gridboard.GridBoard","Rally.ui.cardboard.plugin.CollapsibleColumns","Rally.ui.cardboard.plugin.ColumnPolicy","Rally.ui.cardboard.plugin.FixedHeader","Rally.ui.cardboard.Column","Rally.ui.cardboard.CardBoard","Rally.ui.cardboard.Card","Rally.data.QueryFilter","Rally.ui.notify.Notifier","Rally.ui.AddNew","Rally.ui.LeftRight","Rally.util.Help","Rally.util.Test","Deft.Deferred"],autoScroll:!1,appName:"Portfolio Kanban",cls:"portfolio-kanban",config:{defaultSettings:{fields:"PercentDoneByStoryCount,UserStories"}},mixins:["Rally.clientmetrics.ClientMetricsRecordable"],clientMetrics:[{method:"_showHelp",description:"portfolio-kanban-show-help"}],launch:function(){return Rally.environment.getContext().getSubscription().isModuleEnabled("Rally Portfolio Manager")?(this._createPITypePicker().then({success:function(currentType){this.currentType=currentType,this._loadCardboard()},scope:this}),void 0):(this.add({xtype:"container",html:'<div class="rpm-turned-off" style="padding: 50px; text-align: center;">You do not have RPM enabled for your subscription</div>'}),this._publishContentUpdated(),void 0)},_createPITypePicker:function(){this.piTypePicker&&this.piTypePicker.destroy();var deferred=new Deft.Deferred;return this.piTypePicker=Ext.create("Rally.ui.combobox.PortfolioItemTypeComboBox",{value:this.getSetting("type"),context:this.getContext(),listeners:{change:this._onTypeChange,ready:{fn:function(picker){deferred.resolve(picker.getSelectedType())},single:!0},scope:this}}),deferred.promise},getSettingsFields:function(){return[{type:"project"},{type:"query",config:{plugins:[{ptype:"rallyhelpfield",helpId:271},"rallyfieldvalidationui"]}}]},onDestroy:function(){this._percentDonePopover&&(this._percentDonePopover.destroy(),delete this._percentDonePopover),this.callParent(arguments)},_drawHeader:function(){var header=this.gridboard.getHeader();header&&header.getRight().add([this._buildHelpComponent(),this.piTypePicker,this._buildFilterInfo()])},_loadCardboard:function(policyPluginCmpCfg){this._loadStates({success:function(states){var columns=this._createColumns(states,policyPluginCmpCfg);this.rendered?this._drawCardboard(columns):this.on("afterrender",Ext.bind(this._drawCardboard,this,[columns]),this,{single:!0})},scope:this})},_loadStates:function(options){Ext.create("Rally.data.wsapi.Store",{model:Ext.identityFn("State"),context:this.getContext().getDataContext(),autoLoad:!0,fetch:["Name","WIPLimit","Description"],filters:[{property:"TypeDef",value:this.currentType.get("_ref")},{property:"Enabled",value:!0}],sorters:[{property:"OrderIndex",direction:"ASC"}],listeners:{load:function(store,records){options.success&&options.success.call(options.scope||this,records)}}})},_drawCardboard:function(columns){return this.rendered?(this._showColumns(columns),columns&&0!==columns.length||(this._showNoColumns(),this._onBoardLoad()),void 0):(this.on("afterrender",Ext.bind(this._drawCardboard,this,[columns]),this,{single:!0}),void 0)},_createFilterItem:function(typeName,config){return Ext.apply({xtype:typeName,margin:"-15 0 5 0",showPills:!0,showClear:!0},config)},_showColumns:function(columns){var filters=[{property:"PortfolioItemType",value:this.currentType.get("_ref")}];if(this.getSetting("query"))try{filters.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query")))}catch(e){Rally.ui.notify.Notifier.showError({message:e.message})}var currentTypePath=this.currentType.get("TypePath");this.gridboard?(this.gridboard.modelNames=[currentTypePath],this.cardboard.filterCollection&&this.cardboard.filterCollection.clearAllFilters(),this.cardboard.refresh({columns:columns,ddGroup:currentTypePath,types:[currentTypePath],storeConfig:{filters:filters,context:this.getContext().getDataContext()}})):(this.gridboard=Ext.create("Rally.ui.gridboard.GridBoard",{itemId:"gridboard",toggleState:"board",modelNames:[currentTypePath],context:this.getContext(),addNewPluginConfig:{style:{"float":"left"}},plugins:["rallygridboardaddnew",{ptype:"rallygridboardfiltercontrol",filterControlConfig:{cls:"small gridboard-filter-control",margin:"3 10 3 7",stateful:!0,stateId:this.getContext().getScopedStateId("portfolio-kanban-filter-button"),items:[this._createFilterItem("rallyownerpillfilter",{filterChildren:!1,project:this.getContext().getProject(),showPills:!1}),this._createFilterItem("rallytagpillfilter",{remoteFilter:!0})]}},{ptype:"rallygridboardfieldpicker",boardFieldBlackList:["ObjectID","Description","DisplayColor","FormattedID","Name","Notes","Ready","AcceptedLeafStoryCount","AcceptedLeafStoryPlanEstimateTotal","DirectChildrenCount","LeafStoryCount","LeafStoryPlanEstimateTotal","Rank","DragAndDropRank","UnEstimatedLeafStoryCount","CreationDate","Subscription","Workspace","Changesets","Discussion","LastUpdateDate","Owner"],boardFieldDefaults:this.getSetting("fields").split(","),headerPosition:"left"},{ptype:"rallyboardpolicydisplayable",pluginId:"boardPolicyDisplayable",prefKey:"piKanbanPolicyChecked",checkboxConfig:{boxLabel:"Show Policies",margin:"2 5 5 5"}}],listeners:{toggle:this._gridBoardToggle,scope:this},cardBoardConfig:{attribute:"State",cardConfig:{xtype:"rallyportfoliokanbancard",editable:!0,fields:Rally.apps.portfoliokanban.PortfolioKanbanCard.defaultFields.concat("Discussion"),showColorIcon:!0},columnConfig:{xtype:"rallycardboardcolumn",additionalFetchFields:["Discussion"],enableWipLimit:!0},columns:columns,ddGroup:currentTypePath,listeners:{load:this._onBoardLoad,cardupdated:this._publishContentUpdatedNoDashboardLayout,scope:this},loadDescription:"Portfolio Kanban",loadMask:!1,plugins:[{ptype:"rallyfixedheadercardboard"}],storeConfig:{filters:filters,context:this.context.getDataContext()}},height:this.getHeight()}),this.add(this.gridboard),this._drawHeader())},setHeight:function(height){this.callParent(arguments),this.gridboard&&this.gridboard.setHeight(height)},_onTypeChange:function(picker){var policyCfg,policyPlugin,newType=picker.getSelectedType();newType&&this.currentType&&newType.get("_ref")!==this.currentType.get("_ref")&&(this.currentType=newType,this.gridboard.fireEvent("modeltypeschange",this.gridboard,[newType]),policyPlugin=this.gridboard.getPlugin("boardPolicyDisplayable"),policyPlugin&&(policyCfg={hidden:!policyPlugin.isChecked()}),this._loadCardboard(policyCfg))},_gridBoardToggle:function(toggleState,gridOrBoard){this.cardboard="board"===toggleState?gridOrBoard:null},getMaskId:function(){return"btid-portfolio-kanban-board-load-mask-"+this.id},_onBoardLoad:function(cardboard){this._publishContentUpdated(),Rally.environment.getMessageBus().publish(Rally.Message.piKanbanBoardReady),this.recordComponentReady()},_showNoColumns:function(){this.add({xtype:"container",cls:"no-type-text",html:"<p>This Type has no states defined.</p>"}),this._publishContentUpdated()},_createColumns:function(states,policyPluginCmpCfg){if(!states.length)return void 0;var defaultColumnPolicyPlugin={ptype:"rallycolumnpolicy",policyCmpConfig:Ext.merge({xtype:"rallyportfoliokanbanpolicy",hidden:!0,title:"Exit Policy"},policyPluginCmpCfg||{})},columns=[{columnHeaderConfig:{headerTpl:"No Entry"},value:null,plugins:[defaultColumnPolicyPlugin,"rallycardboardcollapsiblecolumns"]}];return Ext.Array.each(states,function(state){var stateColumnPolicyPlugin=Ext.merge({},defaultColumnPolicyPlugin);stateColumnPolicyPlugin.policyCmpConfig.stateRecord=state,columns.push({value:state.get("_ref"),wipLimit:state.get("WIPLimit"),enableWipLimit:!0,columnHeaderConfig:{record:state,fieldToDisplay:"Name",editable:!1},plugins:[stateColumnPolicyPlugin,"rallycardboardcollapsiblecolumns"]})},this),columns},_buildHelpComponent:function(config){return this.isFullPageApp?null:Ext.create("Ext.Component",Ext.apply({cls:"help-field "+Rally.util.Test.toBrowserTestCssClass("portfolio-kanban-help-container"),renderTpl:Rally.util.Help.getIcon({id:265})},config))},_buildFilterInfo:function(){return this.filterInfo=this.isFullPageApp?null:Ext.create("Rally.ui.tooltip.FilterInfo",{projectName:this.getSetting("project")&&this.getContext().get("project").Name||"Following Global Project Setting",scopeUp:this.getSetting("projectScopeUp"),scopeDown:this.getSetting("projectScopeDown"),query:this.getSetting("query")}),this.filterInfo},_publishContentUpdated:function(){this.fireEvent("contentupdated"),Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(this)},_publishContentUpdatedNoDashboardLayout:function(){this.fireEvent("contentupdated",{dashboardLayout:!1})}})})();

            Rally.launchApp('Rally.apps.portfoliokanban.PortfolioKanbanApp', {
                name:"Portfolio Kanban Board",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .portfolio-kanban {
    overflow-y: hidden;
}

.portfolio-kanban .no-type-text {
    text-align: center;
}

.portfolio-kanban .typeCombo {
    float: right;
}

.portfolio-kanban .readyIndicator {
    visibility: hidden;
}

.portfolio-kanban .timeInState {
    border-top: 1px dotted #CCC;
    color: #666;
    margin-top: 5px;
    padding-top: 5px;
}

.portfolio-kanban .showPolicies {
    font-family: ProximaNovaSemiBold, Helvetica, Arial;
    font-weight: normal;
    float: right;
    margin: 1px 10px 6px 0;
}

.portfolio-kanban .showPolicies  label {
    position: relative;
    top: 1px;
    margin-top: 0;
    padding-left: 4px;
}

.portfolio-kanban .showPolicies .showPoliciesCheckbox {
    position: relative;
    margin-top: 0;
}

.portfolio-kanban .settingsHeader {
    float: left;
    color: gray;
    padding: 1px 0 0 10px;
}

.portfolio-kanban .settingsHeader b {
    padding-right: 5px;
}

.portfolio-kanban .help-field {
    float: right;
}

.portfolio-kanban .field-picker-btn {
    height: 22px;
    margin-top: 3px;
}
    </style>
</head>
<body></body>
</html>
