<!DOCTYPE html>
<html>
<head>
    <title>Kanban Board</title>

    <script type="text/javascript" src="/apps/x/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.kanban.Column",{extend:"Rally.ui.cardboard.Column",alias:"widget.kanbancolumn",getStoreFilter:function(model){var filters=[];return Ext.Array.push(filters,this.callParent(arguments)),"HierarchicalRequirement"===model.elementName&&this.context.getSubscription().StoryHierarchyEnabled&&filters.push({property:"DirectChildrenCount",value:0}),filters}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.kanban.ColumnCardFieldPicker",{extend:"Rally.ui.picker.FieldPicker",alias:"widget.kanbancolumncardfieldpicker",margin:0,config:{rightInitialText:"Apply to All",rightUpdateText:"Remove from All",rightCls:"rui-picker-right-action hyperlink"},initComponent:function(){this.addEvents("rightactionclick"),this.applyToAllFields=[],this.callParent(arguments)},onListItemDeselect:function(record,event,itemEl){var rightActionEl=this._getRightActionEl(record);if(rightActionEl&&event.within(rightActionEl)){var initialTextClicked=rightActionEl.getHTML()===this.rightInitialText;if(this.fireEvent("rightactionclick",this,record,this.getValue(),initialTextClicked),initialTextClicked)return this.applyToAllFields.push(record.get(this.selectionKey)),this._selectRowCheckbox(record.get(this.recordKey)),rightActionEl.update(this.rightUpdateText),!1;Ext.Array.remove(this.applyToAllFields,record.get(this.selectionKey)),rightActionEl.update(this.rightInitialText)}else Ext.Array.remove(this.applyToAllFields,record.get(this.selectionKey));this.callParent(arguments)},getRightListHtml:function(recordData){var tpl="";if("Selected Fields"===recordData.groupSelected&&!Ext.Array.contains(this.alwaysSelectedValues,recordData[this.selectionKey])){var text=Ext.Array.contains(this.applyToAllFields,recordData[this.selectionKey])?this.rightUpdateText:this.rightInitialText;tpl='<div class="'+this.rightCls+'">'+text+"</div>"}return tpl},_getRightActionEl:function(record){var rightSelector=Ext.String.splitWords(this.rightCls).join(".");return this.list.getEl().down(".rui-multi-object-picker-option-id-"+record.get(this.recordKey)+" ."+rightSelector)}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.kanban.ColumnSettingsField",{extend:"Ext.form.field.Base",alias:"widget.kanbancolumnsettingsfield",plugins:["rallyfieldvalidationui"],requires:["Rally.ui.combobox.ComboBox","Rally.ui.TextField","Rally.ui.combobox.FieldValueComboBox","Rally.ui.plugin.FieldValidationUi","Rally.apps.kanban.ColumnCardFieldPicker"],fieldSubTpl:'<div id="{id}" class="settings-grid"></div>',width:600,cls:"column-settings",config:{value:void 0,defaultCardFields:""},onDestroy:function(){this._grid&&(this._grid.destroy(),delete this._grid),this.callParent(arguments)},onRender:function(){this.callParent(arguments),this._store=Ext.create("Ext.data.Store",{fields:["column","shown","wip","scheduleStateMapping","cardFields"],data:[]}),this._grid=Ext.create("Rally.ui.grid.Grid",{autoWidth:!0,renderTo:this.inputEl,columnCfgs:this._getColumnCfgs(),showPagingToolbar:!1,showRowActionsColumn:!1,enableRanking:!1,store:this._store,editingConfig:{publishMessages:!1}})},_getColumnCfgs:function(){var columns=[{text:"Column",dataIndex:"column",emptyCellText:"None",flex:2},{text:"Show",dataIndex:"shown",flex:1,renderer:function(value){return value===!0?"Yes":"No"},editor:{xtype:"rallycombobox",displayField:"name",valueField:"value",editable:!1,storeType:"Ext.data.Store",storeConfig:{remoteFilter:!1,fields:["name","value"],data:[{name:"Yes",value:!0},{name:"No",value:!1}]}}},{text:"WIP",dataIndex:"wip",flex:1,emptyCellText:"&#8734;",editor:{xtype:"rallytextfield",maskRe:/[0-9]/,validator:function(value){return""===value||value>0&&9999>=value||"WIP must be > 0 and < 9999."},rawToValue:function(value){return""===value?value:parseInt(value,10)}}},{text:"Schedule State Mapping",dataIndex:"scheduleStateMapping",emptyCellText:"--No Mapping--",flex:2,editor:{xtype:"rallyfieldvaluecombobox",model:Ext.identityFn("HierarchicalRequirement"),field:"ScheduleState",listeners:{ready:function(combo){var noMapping={};noMapping[combo.displayField]="--No Mapping--",noMapping[combo.valueField]="",combo.store.insert(0,[noMapping])}}}}];return this.shouldShowColumnLevelFieldPicker&&columns.push({text:"Fields",dataIndex:"cardFields",width:300,tdCls:Rally.util.Test.toBrowserTestCssClass("cardfields",""),renderer:this._getRendererForCardFields,scope:this,editor:{xtype:"kanbancolumncardfieldpicker",cls:"card-fields",margin:0,modelTypes:["UserStory","Defect"],autoExpand:!0,alwaysExpanded:!1,hideTrigger:!0,fieldBlackList:["DefectStatus","TaskStatus","DisplayColor"],alwaysSelectedValues:["FormattedID","Name","Owner"],storeConfig:{autoLoad:!1},listeners:{selectionchange:function(picker){picker.validate()},rightactionclick:this._updateColumnCardFieldSettings,scope:this}}}),columns},getSubmitData:function(){var data={};return data[this.name]=Ext.JSON.encode(this._buildSettingValue()),data},_getRendererForCardFields:function(fields){var valWithoutPrefixes=[];return Ext.Array.each(this._getCardFields(fields),function(field){valWithoutPrefixes.push(field.replace(/^c_/,""))}),valWithoutPrefixes.join(", ")},_getCardFields:function(fields){if(Ext.isString(fields)&&fields)return fields.split(",");var val=["FormattedID","Name","Owner"];return Ext.Array.each(fields,function(currentItem){currentItem&&currentItem.data&&!Ext.Array.contains(val,currentItem.data.name)&&val.push(currentItem.data.name)}),val},_updateColumnCardFieldSettings:function(picker,selectedRecord,value,initialText){this._store.each(function(record){if(record.get("shown")){var cardFields=this._getCardFields(record.get("cardFields"));initialText?Ext.Array.contains(cardFields,selectedRecord.get("name"))||cardFields.push(selectedRecord.get("name")):Ext.Array.remove(cardFields,selectedRecord.get("name")),record.set("cardFields",cardFields.join(","))}},this),this._store.loadRawData(this._store.getRange())},_buildSettingValue:function(){var columns={};return this._store.each(function(record){if(record.get("shown")&&(columns[record.get("column")]={wip:record.get("wip"),scheduleStateMapping:record.get("scheduleStateMapping")},this.shouldShowColumnLevelFieldPicker)){var cardFields=this._getCardFields(record.get("cardFields"));columns[record.get("column")].cardFields=cardFields.join(",")}},this),columns},getErrors:function(){var errors=[];return this._storeLoaded&&!Ext.Object.getSize(this._buildSettingValue())&&errors.push("At least one column must be shown."),errors},setValue:function(value){this.callParent(arguments),this._value=value},_getColumnValue:function(columnName){var value=this._value;return value&&Ext.JSON.decode(value)[columnName]},refreshWithNewField:function(field){delete this._storeLoaded,field.getAllowedValueStore().load({callback:function(records,operation,success){var data=Ext.Array.map(records,this._recordToGridRow,this);this._store.loadRawData(data),this.fireEvent("ready"),this._storeLoaded=!0},scope:this})},_recordToGridRow:function(allowedValue){var columnName=allowedValue.get("StringValue"),pref=0===this._store.getCount()?this._getColumnValue(columnName):null,column={column:columnName,shown:!1,wip:"",scheduleStateMapping:"",cardFields:this.defaultCardFields};return pref&&(Ext.apply(column,{shown:!0,wip:pref.wip,scheduleStateMapping:pref.scheduleStateMapping}),pref.cardFields&&Ext.apply(column,{cardFields:pref.cardFields})),column}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.kanban.Settings",{singleton:!0,requires:["Rally.apps.kanban.ColumnSettingsField","Rally.ui.combobox.FieldComboBox","Rally.ui.picker.FieldPicker","Rally.ui.CheckboxField","Rally.ui.plugin.FieldValidationUi"],getFields:function(config){var alwaysSelectedValues=["FormattedID","Name","Owner","BlockedReason"],items=[{name:"groupByField",xtype:"rallyfieldcombobox",model:Ext.identityFn("UserStory"),margin:"10px 0 0 0",fieldLabel:"Group By",listeners:{select:function(combo){this.fireEvent("fieldselected",combo.getRecord().get("fieldDefinition"))},ready:function(combo){combo.store.filterBy(function(record){var attr=record.get("fieldDefinition").attributeDefinition;return attr&&!attr.ReadOnly&&attr.Constrained&&"OBJECT"!==attr.AttributeType&&"COLLECTION"!==attr.AttributeType}),combo.getRecord()&&this.fireEvent("fieldselected",combo.getRecord().get("fieldDefinition"))}},bubbleEvents:["fieldselected","fieldready"]},{name:"columns",readyEvent:"ready",fieldLabel:"",margin:"5px 0 0 80px",xtype:"kanbancolumnsettingsfield",shouldShowColumnLevelFieldPicker:config.shouldShowColumnLevelFieldPicker,defaultCardFields:config.defaultCardFields,handlesEvents:{fieldselected:function(field){this.refreshWithNewField(field)}},listeners:{ready:function(){this.fireEvent("columnsettingsready")}},bubbleEvents:"columnsettingsready"}];if(!config.shouldShowColumnLevelFieldPicker){var fieldBlackList=["DefectStatus","TaskStatus","DisplayColor","DragAndDropRank","Rank"];config.isDndWorkspace===!1&&_.pull(fieldBlackList,"Rank"),items.push({name:"cardFields",fieldLabel:"Card Fields",xtype:"rallyfieldpicker",modelTypes:["userstory","defect"],fieldBlackList:fieldBlackList,alwaysSelectedValues:alwaysSelectedValues,listeners:{selectionchange:function(picker){picker.validate()}},handlesEvents:{columnsettingsready:function(){this.picker&&this.alignPicker()}}})}return items.push({name:"hideReleasedCards",xtype:"rallycheckboxfield",fieldLabel:"Options",margin:"10 0 0 0",boxLabel:"Hide cards in last visible column if assigned to a release"},{type:"cardage",config:{fieldLabel:"",margin:"5 0 10 80"}},{type:"query"}),items}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.kanban.KanbanApp",{extend:"Rally.app.App",requires:["Rally.apps.kanban.Settings","Rally.apps.kanban.Column","Rally.ui.gridboard.GridBoard","Rally.ui.gridboard.plugin.GridBoardAddNew","Rally.ui.gridboard.plugin.GridBoardTagFilter","Rally.ui.gridboard.plugin.GridBoardArtifactTypeChooser","Rally.ui.gridboard.plugin.GridBoardOwnerFilter","Rally.ui.gridboard.plugin.GridBoardFilterInfo","Rally.ui.gridboard.plugin.BoardPolicyDisplayable","Rally.ui.cardboard.plugin.ColumnPolicy","Rally.ui.cardboard.PolicyContainer","Rally.ui.cardboard.CardBoard","Rally.ui.cardboard.plugin.Scrollable","Rally.ui.report.StandardReport","Rally.clientmetrics.ClientMetricsRecordable"],mixins:["Rally.clientmetrics.ClientMetricsRecordable"],cls:"kanban",alias:"widget.kanbanapp",appName:"Kanban",settingsScope:"project",config:{defaultSettings:{groupByField:"ScheduleState",columns:Ext.JSON.encode({Defined:{wip:""},"In-Progress":{wip:""},Completed:{wip:""},Accepted:{wip:""}}),cardFields:"FormattedID,Name,Owner,Discussion,Tasks,Defects",hideReleasedCards:!1,showCardAge:!0,cardAgeThreshold:3,pageSize:25}},launch:function(){Rally.data.ModelFactory.getModel({type:"UserStory",success:this._onStoryModelRetrieved,scope:this})},getOptions:function(){return[{text:"Show Cycle Time Report",handler:this._showCycleTimeReport,scope:this},{text:"Show Throughput Report",handler:this._showThroughputReport,scope:this},{text:"Print",handler:this._print,scope:this}]},getSettingsFields:function(){return Rally.apps.kanban.Settings.getFields({shouldShowColumnLevelFieldPicker:this._shouldShowColumnLevelFieldPicker(),defaultCardFields:this.getSetting("cardFields"),isDndWorkspace:this.getContext().getWorkspace().WorkspaceConfiguration.DragDropRankingEnabled})},onTimeboxScopeChange:function(timeboxScope){this.callParent(arguments),this.gridboard.destroy(),this.launch()},_shouldShowColumnLevelFieldPicker:function(){return this.getContext().isFeatureEnabled("COLUMN_LEVEL_FIELD_PICKER_ON_KANBAN_SETTINGS")},_onStoryModelRetrieved:function(model){this.groupByField=model.getField(this.getSetting("groupByField")),this._addCardboardContent()},_addCardboardContent:function(){var cardboardConfig=this._getCardboardConfig(),columnSetting=this._getColumnSetting();columnSetting&&(cardboardConfig.columns=this._getColumnConfig(columnSetting)),this.gridboard=this.add(this._getGridboardConfig(cardboardConfig)),this.cardboard=this.gridboard.getGridOrBoard()},_getGridboardConfig:function(cardboardConfig){return{xtype:"rallygridboard",stateful:!1,toggleState:"board",cardBoardConfig:cardboardConfig,plugins:[{ptype:"rallygridboardfilterinfo",isGloballyScoped:Ext.isEmpty(this.getSetting("project"))?!0:!1,queryString:this.getSetting("query")},"rallygridboardaddnew",{ptype:"rallyboardpolicydisplayable",prefKey:"kanbanAgreementsChecked",checkboxConfig:{boxLabel:"Agreements"}},{ptype:"rallygridboardartifacttypechooser",artifactTypePreferenceKey:"artifact-types",showAgreements:!1},"rallygridboardtagfilter",{ptype:"rallygridboardownerfilter",stateId:"kanban-owner-filter-"+this.getAppId()}],context:this.getContext(),modelNames:this._getDefaultTypes(),addNewPluginConfig:{listeners:{beforecreate:this._onBeforeCreate,beforeeditorshow:this._onBeforeEditorShow,scope:this}},storeConfig:{filters:this._getFilters()}}},_getColumnConfig:function(columnSetting){var columns=[];return Ext.Object.each(columnSetting,function(column,values){var columnConfig={xtype:"kanbancolumn",enableWipLimit:!0,wipLimit:values.wip,plugins:[{ptype:"rallycolumnpolicy",app:this}],fields:this._getFieldsForColumn(values),value:column,columnHeaderConfig:{headerTpl:column||"None"},listeners:{invalidfilter:{fn:this._onInvalidFilter,scope:this}}};columns.push(columnConfig)},this),columns[columns.length-1].storeConfig={filters:this._getLastColumnFilter()},columns},_getFieldsForColumn:function(values){var columnFields=[];return this._shouldShowColumnLevelFieldPicker()&&(values.cardFields?columnFields=values.cardFields.split(","):this.getSetting("cardFields")&&(columnFields=this.getSetting("cardFields").split(","))),columnFields},_onInvalidFilter:function(){Rally.ui.notify.Notifier.showError({message:"Invalid query: "+this.getSetting("query")})},_getCardboardConfig:function(){return{xtype:"rallycardboard",plugins:[{ptype:"rallycardboardprinting",pluginId:"print"},{ptype:"rallyscrollablecardboard",containerEl:this.getEl()}],types:this._getDefaultTypes(),attribute:this.getSetting("groupByField"),margin:"10px",context:this.getContext(),listeners:{beforecarddroppedsave:this._onBeforeCardSaved,load:this._onBoardLoad,cardupdated:this._publishContentUpdatedNoDashboardLayout,scope:this},columnConfig:{xtype:"rallycardboardcolumn",enableWipLimit:!0},cardConfig:{editable:!0,showIconMenus:!0,fields:this._shouldShowColumnLevelFieldPicker()?[]:this.getSetting("cardFields").split(","),showAge:this.getSetting("showCardAge")?this.getSetting("cardAgeThreshold"):-1,showBlockedReason:!0},loadMask:!1,storeConfig:{context:this.getContext().getDataContext()}}},_getFilters:function(){var filters=[];return this.getSetting("query")&&filters.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),this.getContext().getTimeboxScope()&&filters.push(this.getContext().getTimeboxScope().getQueryFilter()),filters},_getLastColumnFilter:function(){return this.getSetting("hideReleasedCards")?[{property:"Release",value:null}]:[]},_getColumnSetting:function(){var columnSetting=this.getSetting("columns");return columnSetting&&Ext.JSON.decode(columnSetting)},_buildReportConfig:function(report){var shownTypes=this._getShownTypes(),workItems=2===shownTypes.length?"N":shownTypes[0].workItemType,reportConfig={report:report,work_items:workItems};return"ScheduleState"!==this.getSetting("groupByField")&&(reportConfig.filter_field=this.groupByField.displayName),reportConfig},_showCycleTimeReport:function(){this._showReportDialog("Cycle Time Report",this._buildReportConfig(Rally.ui.report.StandardReport.Reports.CycleLeadTime))},_showThroughputReport:function(){this._showReportDialog("Throughput Report",this._buildReportConfig(Rally.ui.report.StandardReport.Reports.Throughput))},_print:function(){this.cardboard.openPrintPage({title:"Kanban Board"})},_getShownTypes:function(){return this.gridboard.artifactTypeChooserPlugin.getChosenTypesConfig()},_getDefaultTypes:function(){return["User Story","Defect"]},_buildStandardReportConfig:function(reportConfig){var scope=this.getContext().getDataContext();return{xtype:"rallystandardreport",padding:10,project:scope.project,projectScopeUp:scope.projectScopeUp,projectScopeDown:scope.projectScopeDown,reportConfig:reportConfig}},_showReportDialog:function(title,reportConfig){var height=450,width=600;this.getEl().mask(),Ext.create("Rally.ui.dialog.Dialog",{title:title,autoShow:!0,draggable:!1,closable:!0,modal:!1,height:height,width:width,items:[Ext.apply(this._buildStandardReportConfig(reportConfig),{height:height,width:width})],listeners:{close:function(){this.getEl().unmask()},scope:this}})},_onBoardLoad:function(){this._publishContentUpdated(),this.setLoading(!1),this._initializeChosenTypes()},_initializeChosenTypes:function(){var artifactsPref=this.gridboard.artifactTypeChooserPlugin.artifactsPref,allowedArtifacts=this.gridboard.getHeader().getRight().query("checkboxfield");Ext.isEmpty(artifactsPref)||artifactsPref.length===allowedArtifacts.length||this.gridboard.getGridOrBoard().addLocalFilter("ByType",artifactsPref,!1)},_onBeforeCreate:function(addNew,record,params){Ext.apply(params,{rankTo:"BOTTOM",rankScope:"BACKLOG"}),record.set(this.getSetting("groupByField"),this.cardboard.getColumns()[0].getValue())},_onBeforeEditorShow:function(addNew,params){params.rankTo="BOTTOM",params.rankScope="BACKLOG",params.iteration="u";var groupByFieldName=this.groupByField.name;params[groupByFieldName]=this.cardboard.getColumns()[0].getValue()},_onBeforeCardSaved:function(column,card,type){var columnSetting=this._getColumnSetting();if(columnSetting){var setting=columnSetting[column.getValue()];setting&&setting.scheduleStateMapping&&card.getRecord().set("ScheduleState",setting.scheduleStateMapping)}},_publishContentUpdated:function(){this.fireEvent("contentupdated"),Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(this),this.recordComponentReady()},_publishContentUpdatedNoDashboardLayout:function(){this.fireEvent("contentupdated",{dashboardLayout:!1})}})})();

            Rally.launchApp('Rally.apps.kanban.KanbanApp', {
                name:"Kanban Board",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .ext-ie .kanban .right .filterInfo {
    width: 25px;
}

.ext-ie .kanban .right .artifact-type-chooser {
    width: 265px;
}

.cardboard .status-content > .status-field.RevisionHistory {
    line-height: 18px;
    cursor: default;
}

.column-settings .settings-grid {
    border: 1px solid #FFF;
}

.column-settings .settings-grid.rally-invalid-field {
    border: 1px solid #F00;
}

.rui-picker-right-action {
  display: inline;
  float: right;
  padding-right: 4px;
}
    </style>
</head>
<body></body>
</html>
