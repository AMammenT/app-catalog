<!DOCTYPE html>
<html>
<head>
    <title>Project CFD</title>

    <script type="text/javascript" src="/apps/x/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function () {
    var Ext = window.Ext4 || window.Ext;

    Ext.define("Rally.apps.charts.Colors", {
        // RGB values obtained from here: http://ux-blog.rallydev.com/?cat=23
        grey4: "#C0C0C0",  // $grey4
        orange: "#FF8200",  // $orange
        gold: "#F6A900",  // $gold
        yellow: "#FAD200",  // $yellow
        lime: "#8DC63F",  // $lime
        green_dk: "#1E7C00",  // $green_dk
        blue_link: "#337EC6",  // $blue_link
        blue: "#005EB8",  // $blue
        purple : "#7832A5",  // $purple,
        pink : "#DA1884",   // $pink,
        grey7 : "#666",

        cumulativeFlowColors : function() {
            return [
                this.grey4, this.orange, this.gold, this.yellow, this.lime, this.green_dk, this.blue_link, this.blue, this.purple, this.pink
            ];
        },

        burnLineColor : function (){ return this.blue; },
        burnColumnColor : function() { return this.lime; }
    });
}());

                (function () {
    var Ext = window.Ext4 || window.Ext;

    Ext.define("Rally.apps.charts.IntegrationHeaders", {

        keyConverters : {
            name : function() { return 'X-RallyIntegrationName'; },
            vendor : function() { return 'X-RallyIntegrationVendor'; },
            platform : function() { return 'X-RallyIntegrationPlatform'; },
            os : function() { return 'X-RallyIntegrationOS'; },
            version : function() { return 'X-RallyIntegrationVersion'; },
            library : function() { return 'X-RallyIntegrationLibrary'; }
        },

        constructor: function(config) {
            this.headers = {
                name : 'A2 Chart',
                vendor : 'Rally Software'
            };

            Ext.merge(this.headers, config.integrationHeaders || {});
            this.callParent(config);
        },
        withName : function(nm) {
            this.headers.name = nm || this.headers.name;
            return this;
        },
        withVendor : function(v) {
            this.headers.vendor = v || this.headers.vendor;
            return this;
        },
        withPlatform : function(newPlatform) {
            this.headers.platform = newPlatform || this.headers.platform;
            return this;
        },
        withVersion : function(newVersion) {
            this.headers.version = newVersion || this.headers.version;
            return this;
        },
        withOS : function(newOS) {
            this.headers.os = newOS || this.headers.os;
            return this;
        },
        withLibrary : function(newLibrary) {
            this.headers.library = newLibrary || this.headers.library;
            return this;
        },
        applyTo : function(config) {
            config.headers = config.headers || {};
            Ext.merge(config.headers, this.build());
            return config;
        },
        build : function() {
            var h = {};
            for (var k in this.headers) {
                if (this.headers.hasOwnProperty(k)) {
                    if (this.headers[k] === null) { continue; }
                    var key = this._keyConverter(k)(k);
                    h[key] = this.headers[k];
                }
            }
            return h;
        },
        _keyConverter: function(key) {
            if (this.keyConverters.hasOwnProperty(key)) {
                return this.keyConverters[key];
            } else {
                return function(x) {return x;};
            }
        }
    });
}());

                (function() {
    var Ext = window.Ext4 || window.Ext;

    Ext.define("Rally.apps.charts.settings.StateFieldPicker", {
        extend: 'Ext.form.FieldSet',
        alias: 'widget.rallychartssettingsstatefieldpicker',

        requires: [
            'Rally.ui.combobox.FieldComboBox',
            'Rally.ui.combobox.FieldValueComboBox'
        ],

        // extjs properties
        flex: 1,
        border: false,
        width: 420,
        layout: 'vbox',
        defaultType: 'textfield',
        defaults    : {
            anchor     : '-10',
            labelWidth : 50
        },
        items: [],

        // custom properties
        settings: undefined, // Map of initial settings values


        initComponent: function() {
            this.callParent();
            this._addStateFieldPicker();

            this.on('statefieldnameselected', this._onStateFieldNameSelected);
            this.on('statefieldnameready', this._onStateFieldNameReady);
            this.on('statefieldvaluesready', this._onStateFieldValuesReady);
            this.on('statefieldvalueschanged', this._onStateFieldValuesChanged);
        },

        /**
         * Event handling
         */
        _onStateFieldNameSelected: function(fieldDefinition) {
            // This happens on field change
            this._refreshStateValuesPicker(fieldDefinition.name);
        },

        _onStateFieldNameReady: function() {
            // This happens on initial settings panel load
            this._updateStateFieldComboboxValue();
            this._refreshStateValuesPicker(this.settings.stateFieldName);
        },

        _onStateFieldValuesReady: function(combo) {
            // This happens on field values combo box ready
            if (_.isString(this.settings.stateFieldValues)) {
                var values = [];
                values = this.settings.stateFieldValues.split(',');
                combo.setValue(values);
            }

            this._publishComponentReady();
        },

        _onStateFieldValuesChanged: function(combo, records) {
            this._sortDisplayedStatesByStore(combo, records);
        },


        _sortDisplayedStatesByStore: function(combo, records) {
            var i, j;
            var values=[];
            if(records.length > 0) {
              for (i=0;i<records[0].store.data.items.length;i++) {
                  for(j=0;j<records.length;j++) {
                     if(records[j].data.StringValue === records[0].store.data.items[i].data.StringValue) {
                         values.push(records[j].data.StringValue);
                     }
                  }
              }
            }
            combo.setValue(values);
        },

        _publishComponentReady: function() {
            if (Rally.BrowserTest) {
                Rally.BrowserTest.publishComponentReady(this);
            }
        },

        _updateStateFieldComboboxValue: function() {
            if(this.settings) {
                var combo = this.down('rallyfieldcombobox');
                combo.setValue(this.settings.stateFieldName);
            }
        },

        _refreshStateValuesPicker: function(fieldName) {
            // if values picker already exists, destroy it
            var old = this.down('rallyfieldvaluecombobox');
            if (old) {
                this.remove(old);
            }
            this._addStateValuesPicker(fieldName);
        },

        _addStateFieldPicker: function() {
            var me = this;
            this.add({
                name: 'stateFieldName',
                xtype: 'rallyfieldcombobox',
                value: this.settings.stateFieldName,
                model: Ext.identityFn('UserStory'),
                margin: '10px 0 0 0',
                width: 180,
                fieldLabel: 'Field',
                listeners: {
                    select: function(combo) {
                        this.fireEvent('statefieldnameselected', combo.getRecord().get('fieldDefinition'));
                    },
                    ready: function(combo) {
                        combo.store.filter({filterFn: function(record) {
                            var attr = record.get('fieldDefinition').attributeDefinition;
                            return attr && !attr.ReadOnly && attr.Constrained && attr.AttributeType !== 'OBJECT' && attr.AttributeType !== 'COLLECTION';
                        }});

                        if (combo.getRecord()) {
                            this.fireEvent('statefieldnameready');
                        } else {
                            me.fireEvent('ready', me);
                        }
                    }
                },
                bubbleEvents: ['statefieldnameselected', 'statefieldnameready']
            });
        },

        _addStateValuesPicker: function(fieldName) {
            this.add({
                xtype: 'rallyfieldvaluecombobox',
                model: Ext.identityFn('UserStory'),
                field: fieldName,
                name: 'stateFieldValues',
                valueField: "StringValue",
                displayField: "StringValue",
                multiSelect: true,
                readyEvent: 'ready',
                fieldLabel: 'Show states',
                margin: '10px 0 0 0',
                width: 400,
                forceSelection: true,
                allowBlank: false,
                listeners: {
                    ready: function(combo) {
                        this.fireEvent('statefieldvaluesready', this);
                    },
                    select: function(combo, records) {
                        this.fireEvent('statefieldvalueschanged', combo, records);
                    }
                },
                listConfig: {
                    itemTpl: Ext.create('Ext.XTemplate',
                        '<div class="statefieldvalue-boundlist-item"><img src="' + Ext.BLANK_IMAGE_URL + '" class="stateFieldValue"/> &nbsp;{StringValue}</div>'),
                    listeners:{
                        afterrender: function(){
                            this.selectedItemCls = Ext.baseCSSPrefix + 'boundlist-selected statefieldvalue-boundlist-selected';
                        }
                    }
                },
                bubbleEvents: ['statefieldvaluesready', 'statefieldvalueschanged']
            });
        }

    });
}());

                (function() {
    var Ext = window.Ext4 || window.Ext;

    Ext.define("Rally.apps.charts.settings.ProjectPicker", {
        extend: "Ext.form.FieldContainer",
        alias: "widget.chartprojectpicker",

        items: [
            {
                xtype: "label",
                text: "Project picker!"
            }
        ]
    });
}());
                (function () {
    var Ext = window.Ext4 || window.Ext;

    Ext.define("Rally.apps.charts.cfd.project.ProjectCFDSettings", {
        requires: [
            "Rally.apps.charts.settings.StateFieldPicker",
            "Rally.apps.charts.settings.ProjectPicker",
            "Rally.ui.datetime.TimeFrame"
        ],

        config: {
            app: undefined // Parent RallyApp instance
        },

        constructor: function (config) {
            this.mergeConfig(config);
        },

        _getTimeFrame: function () {
            return {
                xtype: "rallytimeframe",
                name: "timeFrame",
                label: "Time Frame",
                mapsToMultiplePreferenceKeys: [ "timeFrameQuantity", "timeFrameUnit" ]
            };
        },

        _getStatePicker: function () {
            return {
                xtype: 'rallychartssettingsstatefieldpicker',
                name: 'stateField',
                settings: this.config.app.getSettings()
            };
        },

        _getProjectPicker: function () {
            return {
                type: "project",
                name: "project",
                label: "Project"
            };
        },

        getFields: function () {
            return [
                this._getStatePicker(),
                this._getTimeFrame(),
                this._getProjectPicker()
            ];
        }
    });
}());

                (function () {
    var Ext = window.Ext4 || window.Ext;

    Ext.define("Rally.apps.charts.cfd.project.ProjectCFDCalculator", {
        extend: "Rally.data.lookback.calculator.TimeSeriesCalculator",

        getMetrics: function() {
            var stateFieldName = this.stateFieldName;
            var stateFieldValues = this.stateFieldValues.split(',');

            var metrics = [
            ];

            for (var i = 0; i < stateFieldValues.length; ++i) {
                metrics.push(
                    {as: stateFieldValues[i], groupByField: stateFieldName, allowedValues: [stateFieldValues[i]], f: 'groupByCount', display: 'area'}
                );
            }
            return metrics;
        }

    });
})();
                (function () {
    var Ext = window.Ext4 || window.Ext;

    Ext.define("Rally.apps.charts.cfd.project.ProjectCFDApp", {
        name: 'chartapp',
        extend: "Rally.app.App",
        settingsScope: "workspace",
        componentCls: 'cfd-app',
        cls: 'chart-app',

        requires: [
            'Rally.ui.chart.Chart',
            'Rally.apps.charts.cfd.project.ProjectCFDSettings',
            'Rally.apps.charts.cfd.project.ProjectCFDCalculator',
            'Rally.util.Help',
            'Rally.util.Test',
            'Rally.apps.charts.Colors'
        ],

        config: {
            defaultSettings: {
                stateFieldName: 'ScheduleState',
                stateFieldValues: 'Idea,Defined,In-Progress,Completed,Accepted,Released',
                timeFrameQuantity: 90,
                timeFrameUnit: 'day'
            }
        },
        integrationHeaders : {
            name : "Project CFD"
        },

        chartSettings: undefined, // ProjectCFDChartSettings object

        items: [
            {
                xtype: 'container',
                itemId: 'header',
                cls: 'header'
            }
        ],


        help: {
            id: 279
        },

        getSettingsFields: function () {
            if (!this.chartSettings) {
                this.chartSettings = Ext.create('Rally.apps.charts.cfd.project.ProjectCFDSettings', {
                    app: this
                });
            }
            return this.chartSettings.getFields();
        },

        launch: function () {
            this.callParent(arguments);
            var projectSetting = this.getSetting("project");

            this.down('#header').add(this._buildHelpComponent());

            if (Ext.isEmpty(projectSetting)) {
                var context = this.getContext();
                this.projectScopeDown = context.getProjectScopeDown();
                this.project = context.getProject();
                this.workspace = context.getWorkspace();
                this.loadChart();
            } else {
                this.projectScopeDown = this.getSetting("projectScopeDown");
                this.loadModelInstanceByRefUri(projectSetting,
                    function (record) {
                        this.project = record.data;
                        this.workspace = record.data.Workspace;
                        this.loadChart();
                    },
                    function () {
                        throw new Error("Failed to load project '" + projectSetting + "' from WSAPI.");
                    }
                );
            }
        },

        _buildHelpComponent: function () {
            return Ext.create('Ext.Component', {
                renderTpl: Rally.util.Help.getIcon({
                    id: this.help.id
                })
            });
        },

        loadModelInstanceByRefUri: function (refUri, success, failure) {
            var ref = Rally.util.Ref.getRefObject(refUri);
            Rally.data.ModelFactory.getModel({
                type: ref.getType(),
                scope: this,
                success: function (model) {
                    model.load(ref.getOid(), {
                        scope: this,
                        fetch: ['Name', 'ObjectID', 'Workspace'],
                        success: success,
                        failure: failure
                    });
                }
            });
        },

        loadChart: function() {
            this.add(this._buildChartAppConfig());
            this.down('rallychart').on('snapshotsAggregated', this._onSnapshotDataReady, this);
            this._publishComponentReady();
        },

        _adjustFinalStateData: function (series) {
            var stateField = this.getSetting('stateFieldName');
            var i, j, startVal, finalStates;
            if (stateField === 'ScheduleState') {
                finalStates = [ 'Accepted', 'Released' ];
            } else {
                finalStates = [ this.getSetting('stateFieldValues').split(',').pop() ];
            }
            for (i=0;i<series.length; i++) {
                if (finalStates.indexOf(series[i].name) >= 0) {
                    startVal = series[i].data[0];
                    for (j=0; j < series[i].data.length; j++) {
                        series[i].data[j] -= startVal;
                        if(series[i].data[j] < 0) {
                           series[i].data[j] = 0;
                        }
                    }
                }
            }
        },

        _onSnapshotDataReady: function (chart) {
            this._adjustFinalStateData(chart.chartData.series);
        },

        _buildChartAppConfig: function() {
            return {
                xtype: 'rallychart',
                storeConfig: this._buildChartStoreConfig(),
                calculatorType: 'Rally.apps.charts.cfd.project.ProjectCFDCalculator',
                calculatorConfig: this._buildChartCalculatorConfig(),

                chartColors: Ext.create("Rally.apps.charts.Colors").cumulativeFlowColors(),

                listeners: {
                    chartRendered: this._publishComponentReady,
                    scope: this
                },

                chartConfig: {
                    chart: {
                        zoomType: 'xy'
                    },
                    title: {
                        text: this.project.Name + " Cumulative Flow Diagram"
                    },
                    xAxis: {
                        tickmarkPlacement: 'on',
                        tickInterval: 20,
                        title: {
                            text: 'Days'
                        }
                    },
                    yAxis: [
                        {
                            title: {
                                text: 'Count'
                            }
                        }
                    ],
                    plotOptions: {
                        series: {
                            marker: {
                                enabled: false
                            }
                        },
                        area: {
                            stacking: 'normal'
                        }
                    }
                }
            };
        },

        _buildChartStoreConfig: function() {
            var config = {
                context: { workspace: this.workspace._ref },
                find: this._buildChartStoreConfigFind(),
                fetch: this._buildChartStoreConfigFetch(),
                hydrate: this._buildChartStoreConfigHydrate(),
                compress: true
            };
            return Ext.create("Rally.apps.charts.IntegrationHeaders",this).applyTo(config);
        },

        _buildChartStoreConfigFind: function() {
            var find = {
                '_TypeHierarchy': { '$in' : [ -51038, -51006 ] },
                'Children': null,
                '_ValidTo'  : { '$gt' : this._buildChartStoreConfigValidFrom() }
            };

            if (this.projectScopeDown) {
                find._ProjectHierarchy = this.project.ObjectID;
            } else {
                find.Project = this.project.ObjectID;
            }

            return find;
        },

        _buildChartStoreConfigValidFrom: function() {
            var today = this._getNow();
            var timeFrameUnit = this.getSetting("timeFrameUnit");
            var timeFrameQuantity = this.getSetting("timeFrameQuantity");
            var validFromDate = Rally.util.DateTime.add(today, timeFrameUnit, -timeFrameQuantity);
            return Rally.util.DateTime.toIsoString(validFromDate, true);
        },

        _getNow: function() {
            return new Date();
        },

        _buildChartStoreConfigFetch: function() {
            var stateFieldName = this.getSetting('stateFieldName');
            return [stateFieldName, 'PlanEstimate'];
        },

        _buildChartStoreConfigHydrate: function() {
            var stateFieldName = this.getSetting('stateFieldName');
            return [stateFieldName];
        },

        _buildChartCalculatorConfig: function() {
            var stateFieldName = this.getSetting('stateFieldName');
            var stateFieldValues = this.getSetting('stateFieldValues');
            var startDate = this._buildChartStoreConfigValidFrom();
            return {
                stateFieldName: stateFieldName,
                stateFieldValues: stateFieldValues,
                startDate: startDate
            };
        },

        _publishComponentReady: function() {
            if (Rally.BrowserTest) {
                Rally.BrowserTest.publishComponentReady(this);
            }
        }

    });

}());


            Rally.launchApp('Rally.apps.charts.cfd.project.ProjectCFDApp', {
                name:"Project CFD",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .burndown-app .chartControls,
.app-settings .settings-form .paddedSettingCmp {
    margin: 15px;
    border: 0px;
}

.burndown-app .chartControls .rui-triggerfield {
    display: inline-block;
}

.burndown-app .chartControls label {
    display: inline-block;
    font-size: 1.2em;
    margin: 3px 8px;
}

.portfolio-cfd-app,
.portfolio-burnup-app,
.burndown-app {
    margin: 10px;
    padding-right: 20px;
    background-color: transparent;
}

.portfolio-cfd-app .rally-help-icon,
.burndown-app .rally-help-icon,
.portfolio-burnup-app .rally-help-icon,
.chart-app .rally-help-icon {
    float: right;
}

.portfolio-cfd-app .chart,
.portfolio-burnup-app .chart {
    min-height: 2em;
}

.app-settings .settings-form .piButton {
    padding: 5px 15px 7px 15px;
    z-index: 101;
    margin-bottom: 10px;
}

.app-settings .settings-form .piDisplayField {
    background-color: #e2eff6;
    margin-left: -10px;
    min-width: 250px;
    padding: 5px 20px 3px 25px;
    z-index: 100;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
}

.app-settings .settings-form .settingsLabel {
    display: block;
    font-family: NotoSansBold, Helvetica, Arial;
    font-weight: normal;
    min-height: 20px;
    text-transform: uppercase;
    width: 100px;
}

table.settings-showLabels label {
    white-space: nowrap;
    width: auto;
}
table.settings-showLabels td {
    width:130px;
}

.schedule-state-selector .@{prefix}boundlist-selected .@{prefix}form-checkbox {
    background-position: 0 -13px;
}

.statefieldvalue-boundlist-item img.stateFieldValue {
    background: transparent url('checkbox.gif');
    height: 13px;
    width: 13px;
}
.statefieldvalue-boundlist-selected img.stateFieldValue{
    background: transparent url('checkbox.gif');
    height: 13px;
    width: 13px;
    background-position-x: 0px;
    background-position-y: -13px;
}

    </style>
</head>
<body></body>
</html>
