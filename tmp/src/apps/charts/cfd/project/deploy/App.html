<!DOCTYPE html>
<html>
<head>
    <title>Project CFD</title>

    <script type="text/javascript" src="/apps/x/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.charts.Colors",{grey4:"#C0C0C0",orange:"#FF8200",gold:"#F6A900",yellow:"#FAD200",lime:"#8DC63F",green_dk:"#1E7C00",blue_link:"#337EC6",blue:"#005EB8",purple:"#7832A5",pink:"#DA1884",grey7:"#666",cumulativeFlowColors:function(){return[this.grey4,this.orange,this.gold,this.yellow,this.lime,this.green_dk,this.blue_link,this.blue,this.purple,this.pink]},burnLineColor:function(){return this.blue},burnColumnColor:function(){return this.lime}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.charts.IntegrationHeaders",{keyConverters:{name:function(){return"X-RallyIntegrationName"},vendor:function(){return"X-RallyIntegrationVendor"},platform:function(){return"X-RallyIntegrationPlatform"},os:function(){return"X-RallyIntegrationOS"},version:function(){return"X-RallyIntegrationVersion"},library:function(){return"X-RallyIntegrationLibrary"}},constructor:function(config){this.headers={name:"A2 Chart",vendor:"Rally Software"},Ext.merge(this.headers,config.integrationHeaders||{}),this.callParent(config)},withName:function(nm){return this.headers.name=nm||this.headers.name,this},withVendor:function(v){return this.headers.vendor=v||this.headers.vendor,this},withPlatform:function(newPlatform){return this.headers.platform=newPlatform||this.headers.platform,this},withVersion:function(newVersion){return this.headers.version=newVersion||this.headers.version,this},withOS:function(newOS){return this.headers.os=newOS||this.headers.os,this},withLibrary:function(newLibrary){return this.headers.library=newLibrary||this.headers.library,this},applyTo:function(config){return config.headers=config.headers||{},Ext.merge(config.headers,this.build()),config},build:function(){var h={};for(var k in this.headers)if(this.headers.hasOwnProperty(k)){if(null===this.headers[k])continue;var key=this._keyConverter(k)(k);h[key]=this.headers[k]}return h},_keyConverter:function(key){return this.keyConverters.hasOwnProperty(key)?this.keyConverters[key]:function(x){return x}}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.charts.settings.StateFieldPicker",{extend:"Ext.form.FieldSet",alias:"widget.rallychartssettingsstatefieldpicker",requires:["Rally.ui.combobox.FieldComboBox","Rally.ui.combobox.FieldValueComboBox"],flex:1,border:!1,width:420,layout:"vbox",defaultType:"textfield",defaults:{anchor:"-10",labelWidth:50},items:[],settings:void 0,initComponent:function(){this.callParent(),this._addStateFieldPicker(),this.on("statefieldnameselected",this._onStateFieldNameSelected),this.on("statefieldnameready",this._onStateFieldNameReady),this.on("statefieldvaluesready",this._onStateFieldValuesReady),this.on("statefieldvalueschanged",this._onStateFieldValuesChanged)},_onStateFieldNameSelected:function(fieldDefinition){this._refreshStateValuesPicker(fieldDefinition.name)},_onStateFieldNameReady:function(){this._updateStateFieldComboboxValue(),this._refreshStateValuesPicker(this.settings.stateFieldName)},_onStateFieldValuesReady:function(combo){if(_.isString(this.settings.stateFieldValues)){var values=[];values=this.settings.stateFieldValues.split(","),combo.setValue(values)}this._publishComponentReady()},_onStateFieldValuesChanged:function(combo,records){this._sortDisplayedStatesByStore(combo,records)},_sortDisplayedStatesByStore:function(combo,records){var i,j,values=[];if(records.length>0)for(i=0;records[0].store.data.items.length>i;i++)for(j=0;records.length>j;j++)records[j].data.StringValue===records[0].store.data.items[i].data.StringValue&&values.push(records[j].data.StringValue);combo.setValue(values)},_publishComponentReady:function(){Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(this)},_updateStateFieldComboboxValue:function(){if(this.settings){var combo=this.down("rallyfieldcombobox");combo.setValue(this.settings.stateFieldName)}},_refreshStateValuesPicker:function(fieldName){var old=this.down("rallyfieldvaluecombobox");old&&this.remove(old),this._addStateValuesPicker(fieldName)},_addStateFieldPicker:function(){var me=this;this.add({name:"stateFieldName",xtype:"rallyfieldcombobox",value:this.settings.stateFieldName,model:Ext.identityFn("UserStory"),margin:"10px 0 0 0",width:180,fieldLabel:"Field",listeners:{select:function(combo){this.fireEvent("statefieldnameselected",combo.getRecord().get("fieldDefinition"))},ready:function(combo){combo.store.filter({filterFn:function(record){var attr=record.get("fieldDefinition").attributeDefinition;return attr&&!attr.ReadOnly&&attr.Constrained&&"OBJECT"!==attr.AttributeType&&"COLLECTION"!==attr.AttributeType}}),combo.getRecord()?this.fireEvent("statefieldnameready"):me.fireEvent("ready",me)}},bubbleEvents:["statefieldnameselected","statefieldnameready"]})},_addStateValuesPicker:function(fieldName){this.add({xtype:"rallyfieldvaluecombobox",model:Ext.identityFn("UserStory"),field:fieldName,name:"stateFieldValues",valueField:"StringValue",displayField:"StringValue",multiSelect:!0,readyEvent:"ready",fieldLabel:"Show states",margin:"10px 0 0 0",width:400,forceSelection:!0,allowBlank:!1,listeners:{ready:function(combo){this.fireEvent("statefieldvaluesready",this)},select:function(combo,records){this.fireEvent("statefieldvalueschanged",combo,records)}},listConfig:{itemTpl:Ext.create("Ext.XTemplate",'<div class="statefieldvalue-boundlist-item"><img src="'+Ext.BLANK_IMAGE_URL+'" class="stateFieldValue"/> &nbsp;{StringValue}</div>'),listeners:{afterrender:function(){this.selectedItemCls=Ext.baseCSSPrefix+"boundlist-selected statefieldvalue-boundlist-selected"}}},bubbleEvents:["statefieldvaluesready","statefieldvalueschanged"]})}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.charts.settings.ProjectPicker",{extend:"Ext.form.FieldContainer",alias:"widget.chartprojectpicker",items:[{xtype:"label",text:"Project picker!"}]})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.charts.cfd.project.ProjectCFDSettings",{requires:["Rally.apps.charts.settings.StateFieldPicker","Rally.apps.charts.settings.ProjectPicker","Rally.ui.datetime.TimeFrame"],config:{app:void 0},constructor:function(config){this.mergeConfig(config)},_getTimeFrame:function(){return{xtype:"rallytimeframe",name:"timeFrame",label:"Time Frame",mapsToMultiplePreferenceKeys:["timeFrameQuantity","timeFrameUnit"]}},_getStatePicker:function(){return{xtype:"rallychartssettingsstatefieldpicker",name:"stateField",settings:this.config.app.getSettings()}},_getProjectPicker:function(){return{type:"project",name:"project",label:"Project"}},getFields:function(){return[this._getStatePicker(),this._getTimeFrame(),this._getProjectPicker()]}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.charts.cfd.project.ProjectCFDCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",getMetrics:function(){for(var stateFieldName=this.stateFieldName,stateFieldValues=this.stateFieldValues.split(","),metrics=[],i=0;stateFieldValues.length>i;++i)metrics.push({as:stateFieldValues[i],groupByField:stateFieldName,allowedValues:[stateFieldValues[i]],f:"groupByCount",display:"area"});return metrics}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.charts.cfd.project.ProjectCFDApp",{name:"chartapp",extend:"Rally.app.App",settingsScope:"workspace",componentCls:"cfd-app",cls:"chart-app",requires:["Rally.ui.chart.Chart","Rally.apps.charts.cfd.project.ProjectCFDSettings","Rally.apps.charts.cfd.project.ProjectCFDCalculator","Rally.util.Help","Rally.util.Test","Rally.apps.charts.Colors"],config:{defaultSettings:{stateFieldName:"ScheduleState",stateFieldValues:"Idea,Defined,In-Progress,Completed,Accepted,Released",timeFrameQuantity:90,timeFrameUnit:"day"}},integrationHeaders:{name:"Project CFD"},chartSettings:void 0,items:[{xtype:"container",itemId:"header",cls:"header"}],help:{id:279},getSettingsFields:function(){return this.chartSettings||(this.chartSettings=Ext.create("Rally.apps.charts.cfd.project.ProjectCFDSettings",{app:this})),this.chartSettings.getFields()},launch:function(){this.callParent(arguments);var projectSetting=this.getSetting("project");if(this.down("#header").add(this._buildHelpComponent()),Ext.isEmpty(projectSetting)){var context=this.getContext();this.projectScopeDown=context.getProjectScopeDown(),this.project=context.getProject(),this.workspace=context.getWorkspace(),this.loadChart()}else this.projectScopeDown=this.getSetting("projectScopeDown"),this.loadModelInstanceByRefUri(projectSetting,function(record){this.project=record.data,this.workspace=record.data.Workspace,this.loadChart()},function(){throw Error("Failed to load project '"+projectSetting+"' from WSAPI.")})},_buildHelpComponent:function(){return Ext.create("Ext.Component",{renderTpl:Rally.util.Help.getIcon({id:this.help.id})})},loadModelInstanceByRefUri:function(refUri,success,failure){var ref=Rally.util.Ref.getRefObject(refUri);Rally.data.ModelFactory.getModel({type:ref.getType(),scope:this,success:function(model){model.load(ref.getOid(),{scope:this,fetch:["Name","ObjectID","Workspace"],success:success,failure:failure})}})},loadChart:function(){this.add(this._buildChartAppConfig()),this.down("rallychart").on("snapshotsAggregated",this._onSnapshotDataReady,this),this._publishComponentReady()},_adjustFinalStateData:function(series){var stateField=this.getSetting("stateFieldName"),i,j,startVal,finalStates;for(finalStates="ScheduleState"===stateField?["Accepted","Released"]:[this.getSetting("stateFieldValues").split(",").pop()],i=0;series.length>i;i++)if(finalStates.indexOf(series[i].name)>=0)for(startVal=series[i].data[0],j=0;series[i].data.length>j;j++)series[i].data[j]-=startVal,0>series[i].data[j]&&(series[i].data[j]=0)},_onSnapshotDataReady:function(chart){this._adjustFinalStateData(chart.chartData.series)},_buildChartAppConfig:function(){return{xtype:"rallychart",storeConfig:this._buildChartStoreConfig(),calculatorType:"Rally.apps.charts.cfd.project.ProjectCFDCalculator",calculatorConfig:this._buildChartCalculatorConfig(),chartColors:Ext.create("Rally.apps.charts.Colors").cumulativeFlowColors(),listeners:{chartRendered:this._publishComponentReady,scope:this},chartConfig:{chart:{zoomType:"xy"},title:{text:this.project.Name+" Cumulative Flow Diagram"},xAxis:{tickmarkPlacement:"on",tickInterval:20,title:{text:"Days"}},yAxis:[{title:{text:"Count"}}],plotOptions:{series:{marker:{enabled:!1}},area:{stacking:"normal"}}}}},_buildChartStoreConfig:function(){var config={context:{workspace:this.workspace._ref},find:this._buildChartStoreConfigFind(),fetch:this._buildChartStoreConfigFetch(),hydrate:this._buildChartStoreConfigHydrate(),compress:!0};return Ext.create("Rally.apps.charts.IntegrationHeaders",this).applyTo(config)},_buildChartStoreConfigFind:function(){var find={_TypeHierarchy:{$in:[-51038,-51006]},Children:null,_ValidTo:{$gt:this._buildChartStoreConfigValidFrom()}};return this.projectScopeDown?find._ProjectHierarchy=this.project.ObjectID:find.Project=this.project.ObjectID,find},_buildChartStoreConfigValidFrom:function(){var today=this._getNow(),timeFrameUnit=this.getSetting("timeFrameUnit"),timeFrameQuantity=this.getSetting("timeFrameQuantity"),validFromDate=Rally.util.DateTime.add(today,timeFrameUnit,-timeFrameQuantity);return Rally.util.DateTime.toIsoString(validFromDate,!0)},_getNow:function(){return new Date},_buildChartStoreConfigFetch:function(){var stateFieldName=this.getSetting("stateFieldName");return[stateFieldName,"PlanEstimate"]},_buildChartStoreConfigHydrate:function(){var stateFieldName=this.getSetting("stateFieldName");return[stateFieldName]},_buildChartCalculatorConfig:function(){var stateFieldName=this.getSetting("stateFieldName"),stateFieldValues=this.getSetting("stateFieldValues"),startDate=this._buildChartStoreConfigValidFrom();return{stateFieldName:stateFieldName,stateFieldValues:stateFieldValues,startDate:startDate}},_publishComponentReady:function(){Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(this)}})})();

            Rally.launchApp('Rally.apps.charts.cfd.project.ProjectCFDApp', {
                name:"Project CFD",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .burndown-app .chartControls,
.app-settings .settings-form .paddedSettingCmp {
    margin: 15px;
    border: 0px;
}

.burndown-app .chartControls .rui-triggerfield {
    display: inline-block;
}

.burndown-app .chartControls label {
    display: inline-block;
    font-size: 1.2em;
    margin: 3px 8px;
}

.portfolio-cfd-app,
.portfolio-burnup-app,
.burndown-app {
    margin: 10px;
    padding-right: 20px;
    background-color: transparent;
}

.portfolio-cfd-app .rally-help-icon,
.burndown-app .rally-help-icon,
.portfolio-burnup-app .rally-help-icon,
.chart-app .rally-help-icon {
    float: right;
}

.portfolio-cfd-app .chart,
.portfolio-burnup-app .chart {
    min-height: 2em;
}

.app-settings .settings-form .piButton {
    padding: 5px 15px 7px 15px;
    z-index: 101;
    margin-bottom: 10px;
}

.app-settings .settings-form .piDisplayField {
    background-color: #e2eff6;
    margin-left: -10px;
    min-width: 250px;
    padding: 5px 20px 3px 25px;
    z-index: 100;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
}

.app-settings .settings-form .settingsLabel {
    display: block;
    font-family: NotoSansBold, Helvetica, Arial;
    font-weight: normal;
    min-height: 20px;
    text-transform: uppercase;
    width: 100px;
}

table.settings-showLabels label {
    white-space: nowrap;
    width: auto;
}
table.settings-showLabels td {
    width:130px;
}

.schedule-state-selector .@{prefix}boundlist-selected .@{prefix}form-checkbox {
    background-position: 0 -13px;
}

.statefieldvalue-boundlist-item img.stateFieldValue {
    background: transparent url('checkbox.gif');
    height: 13px;
    width: 13px;
}
.statefieldvalue-boundlist-selected img.stateFieldValue{
    background: transparent url('checkbox.gif');
    height: 13px;
    width: 13px;
    background-position-x: 0px;
    background-position-y: -13px;
}

    </style>
</head>
<body></body>
</html>
