<!DOCTYPE html>
<html>
<head>
    <title>Team Board</title>

    <script type="text/javascript" src="/apps/x/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function() {
    var Ext = window.Ext4 || window.Ext;

    Ext.define('Rally.apps.teamboard.TeamBoardCardContentLeft', {
        alias: 'plugin.rallyteamboardcardcontentleft',
        extend: 'Rally.ui.cardboard.plugin.CardContentLeft',

        getCardHeader: function(){
            var record = this.card.getRecord();

            var name = record.get('FirstName') && record.get('LastName') ? record.get('FirstName') + ' ' + record.get('LastName') : record.get('_refObjectName');
            var role = record.get('Role') === 'None' ? '' : record.get('Role');

            return '<table class="card-header">' +
                '<tr>' +
                '<td>' +
                '<img src="' + Rally.util.User.getProfileImageUrl(40, record.get('_ref')) + '">' +
                '</td>' +
                '<td class="card-header-spacer"></td>' +
                '<td class="card-header-user-info">' +
                '<div class="team-member-name">' + Rally.apps.teamboard.TeamBoardUtil.linkToAdminPage(record, name) + '</div>' +
                '<div class="team-member-role">' + role + '</div>' +
                '</td>' +
                '</tr>' +
                '</table>';
        }
    });
})();
                (function() {
    var Ext = window.Ext4 || window.Ext;

    Ext.define('Rally.apps.teamboard.TeamBoardCardContentRight', {
        alias: 'plugin.rallyteamboardcardcontentright',
        extend: 'Ext.AbstractPlugin',
        requires: ['Rally.ui.cardboard.plugin.CardContentRight'],

        init: function (card) {
            card.contentRightPlugin = this;
        },

        getHtml: function() {
            return '<td class="rui-card-right-side">' +
                    '<div class="' + Rally.ui.cardboard.plugin.CardContentRight.TOP_SIDE_CLS + '"></div>' +
                    '<div class="' + Rally.ui.cardboard.plugin.CardContentRight.BOTTOM_SIDE_CLS + '"></div>' +
                   '</td>';
        }
    });
})();
                (function() {
    var Ext = window.Ext4 || window.Ext;

    Ext.define('Rally.apps.teamboard.TeamBoardUtil', {
        requires: [
            'Rally.nav.DetailLink'
        ],
        singleton: true,

        linkToAdminPage: function(record, text, subPage){
            if(Rally.environment.getContext().getPermissions().isWorkspaceOrSubscriptionAdmin() || this._isProjectAdmin(record)){
                return Rally.nav.DetailLink.getLink({
                    record: record,
                    showHover: false,
                    subPage: subPage,
                    text: text
                });
            }else{
                return text;
            }
        },

        _isProjectAdmin: function(record) {
            var permissions = Rally.environment.getContext().getPermissions();
            return record.self.prettyTypeName === 'project' ? permissions.isProjectAdmin(record.get('_ref')) : permissions.isProjectAdminInAnyProject();
        }
    });

})();
                (function() {
    var Ext = window.Ext4 || window.Ext;

    Ext.define('Rally.apps.teamboard.TeamBoardCard', {
        alias: 'widget.rallyteamboardcard',
        extend: 'Rally.ui.cardboard.Card',
        requires: [
            'Rally.apps.teamboard.TeamBoardCardContentLeft',
            'Rally.apps.teamboard.TeamBoardCardContentRight',
            'Rally.apps.teamboard.TeamBoardUtil',
            'Rally.util.User'
        ],

        inheritableStatics: {
            getFetchFields: function() {
                return ['FirstName', 'LastName', 'Role'];
            }
        },

        setupPlugins: function(){
            return [{
                ptype: 'rallyteamboardcardcontentleft'
            }, {
                ptype: 'rallyteamboardcardcontentright'
            }];
        }
    });

})();
                (function() {
    var Ext = window.Ext4 || window.Ext;

    Ext.define('Rally.apps.teamboard.TeamBoardDropController', {
        alias: 'plugin.rallyteamboarddropcontroller',
        extend: 'Rally.ui.cardboard.plugin.ColumnDropController',
        requires: ['Rally.data.util.RecordCollection'],

        handleBeforeCardDroppedSave: function (options) {
            Rally.data.util.RecordCollection.modify({
                add: [options.column.getValue()],
                collectionName: options.column.attribute,
                parentRecord: options.record,
                remove: [options.sourceColumn.getValue()],
                saveOptions: {
                    success: function(){
                        this._onDropSaveSuccess(options.column, options.sourceColumn, options.card, options.record, options.type);
                    },
                    failure: function(){
                        this._onDropSaveFailure(options.column, options.sourceColumn, undefined, options.record, options.card, options.sourceIndex, {});
                    },
                    scope: this
                }
            });
        }
    });

})();
                (function () {
    var Ext = window.Ext4 || window.Ext;

    Ext.define('Rally.apps.teamboard.plugin.TeamBoardIterationAwarePlugin', {
        extend: 'Ext.AbstractPlugin',

        init: function(cmp) {
            this.callParent(arguments);

            this.cmp = cmp;
            this.cmp.on('iterationcomboready', this.onIterationComboReady, this, {single: true});
        },

        findIterationRecord: function(ref, combo) {
            return ref && combo.findRecordByValue(ref);
        },

        onIterationComboReady: function(cmp, combo){
            combo.on('change', this.onIterationComboChange, this);
            this.showData(this.findIterationRecord(combo.getValue(), combo));
        },

        onIterationComboChange: function(combo, newValue){
            this.showData(this.findIterationRecord(newValue, combo));
        },

        showData: Ext.emptyFn
    });
})();
                (function () {
    var Ext = window.Ext4 || window.Ext;

    Ext.define('Rally.apps.teamboard.plugin.TeamBoardUserIterationCapacity', {
        alias: 'plugin.rallyteamboarduseriterationcapacity',
        extend: 'Rally.apps.teamboard.plugin.TeamBoardIterationAwarePlugin',
        requires: ['Rally.data.wsapi.Filter', 'Rally.ui.cardboard.plugin.CardContentRight', 'Rally.ui.grid.Grid'],

        inheritableStatics: {
            _getProgressBarTpl: function() {
                this.progressBarTpl = this.progressBarTpl || Ext.create('Rally.ui.renderer.template.progressbar.ProgressBarTemplate', {
                    calculateColorFn: function(recordData) {
                        return recordData.Load > 1 ? '#ec0000' : '#76c10f';
                    },
                    isClickable: true,
                    height: '14px',
                    percentDoneName: 'Load',
                    width: '60px'
                });
                return this.progressBarTpl;
            }
        },

        onIterationComboReady: function(cmp, combo){
            this.callParent(arguments);

            this.cmp.on('cardupdated', function(){
                this.showData(this.findIterationRecord(combo.getValue(), combo));
            }, this);
        },

        showData: function(iterationRecord){
            if(iterationRecord) {
                iterationRecord.getCollection('UserIterationCapacities', {
                    autoLoad: true,
                    fetch: 'Capacity,Iteration,Load,TaskEstimates,User',
                    limit: Infinity,
                    listeners: {
                        load: function (store, records) {
                            this._updateCapacities(records, true);
                        },
                        scope: this
                    }
                });
            }else{
                this._updateCapacities([], false);
            }
        },

        _updateCapacities: function(userIterationCapacityRecords, showSwipe) {
            _.each(this.cmp.getCards(), function(card){
                var topEl = card.getEl().down('.' + Rally.ui.cardboard.plugin.CardContentRight.TOP_SIDE_CLS);
                var bottomEl = card.getEl().down('.' + Rally.ui.cardboard.plugin.CardContentRight.BOTTOM_SIDE_CLS);

                var uicRecord = this._findUserIterationCapacityFor(card.getRecord(), userIterationCapacityRecords);
                if(uicRecord){
                    topEl.update(this.self._getProgressBarTpl().apply(uicRecord.data));
                    topEl.on('click', function(e, targetEl){
                        this._showTasksGrid(Ext.get(targetEl), uicRecord);
                    }, this, {delegate: '.progress-bar-container'});

                    bottomEl.update(this._getHasCapacityHtml(uicRecord));
                }else{
                    topEl.update('');
                    bottomEl.update(showSwipe ? this._getAddCapacityHtml() : '');
                }

                if(showSwipe){
                    card.getEl().addCls('rui-card-swipe');
                }else{
                    card.getEl().removeCls('rui-card-swipe');
                }
            }, this);
        },

        _findUserIterationCapacityFor: function(userRecord, userIterationCapacityRecords) {
            return _.find(userIterationCapacityRecords, function(record){
                return record.get('User')._ref === userRecord.get('_ref');
            });
        },

        _getHasCapacityHtml: function(record) {
            return Ext.create('Rally.ui.renderer.template.CardPlanEstimateTemplate', record.get('Capacity'), 'Capacity').apply();
        },

        _getAddCapacityHtml: function() {
            return Ext.create('Rally.ui.renderer.template.CardPlanEstimateTemplate', '--', 'Capacity', 'no-estimate').apply();
        },

        _showTasksGrid: function(target, uicRecord) {
            Ext.create('Rally.ui.popover.Popover', {
                items: [{
                    xtype: 'rallygrid',
                    columnCfgs: ['FormattedID', 'Name', 'Owner', 'State', 'Estimate', 'ToDo', 'Actuals', 'Blocked'],
                    model: Ext.identityFn('Task'),
                    storeConfig: {
                        context: {
                            project: this.cmp.getValue(),
                            projectScopeDown: false,
                            projectScopeUp: false
                        },
                        filters: Rally.data.wsapi.Filter.and([
                            {property: 'Iteration', value: uicRecord.get('Iteration')._ref},
                            {property: 'Owner', value: uicRecord.get('User')._ref}
                        ])
                    }
                }],
                target: target,
                width: 700
            });
        }
    });
})();
                (function () {
    var Ext = window.Ext4 || window.Ext;

    Ext.define('Rally.apps.teamboard.plugin.TeamBoardWip', {
        alias: 'plugin.rallyteamboardwip',
        extend: 'Rally.apps.teamboard.plugin.TeamBoardIterationAwarePlugin',
        requires: ['Rally.data.wsapi.Filter', 'Rally.util.DateTime'],

        inheritableStatics: {
            _inProgressDuring: function(iterationRecord) {
                return Rally.data.wsapi.Filter.and([
                    {property: 'ActualStartDate', operator: '<=', value: Rally.util.DateTime.toIsoString(iterationRecord.get('EndDate'))},
                    Rally.data.wsapi.Filter.or([
                        {property: 'ActualEndDate', operator: '>=', value: Rally.util.DateTime.toIsoString(iterationRecord.get('StartDate'))},
                        {property: 'ActualEndDate', value: 'null'}
                    ])
                ]);
            },

            _inProgressNow: function() {
                return Rally.data.wsapi.Filter.and([
                    {property: 'ActualStartDate', operator: '!=', value: 'null'},
                    {property: 'ActualEndDate', value: 'null'}
                ]);
            }
        },

        onIterationComboReady: function(cmp, combo){
            this.wipContainer = combo.up().add({
                xtype: 'container',
                cls: 'wip-container'
            });

            this.callParent(arguments);
        },

        showData: function(iterationRecord){
            if(!Rally.environment.getContext().getSubscription().isModuleEnabled('Rally Portfolio Manager')) {
                return;
            }

            this.wipContainer.removeAll();

            var store = Ext.create('Rally.data.wsapi.Store', {
                context: {
                    project: this.cmp.getValue(),
                    projectScopeDown: false,
                    projectScopeUp: false
                },
                fetch: 'FormattedID,Name',
                filters: Rally.data.wsapi.Filter.and([
                    {property: 'Ordinal', value: 0},
                    iterationRecord ? this.self._inProgressDuring(iterationRecord) : this.self._inProgressNow()
                ]),
                model: Ext.identityFn('PortfolioItem')
            });
            store.load({
                callback: this._onWipLoaded,
                scope: this
            });
        },

        _onWipLoaded: function(wipRecords) {
            _.each(wipRecords, function(record){
                this.wipContainer.add({
                    xtype: 'component',
                    cls: 'ellipses wip-item',
                    html: Rally.util.DetailLink.getLink({
                        record: record,
                        text: record.get('FormattedID')
                    }) + ': ' + record.get('Name')
                });
            }, this);
        }
    });
})();
                (function() {
    var Ext = window.Ext4 || window.Ext;

    Ext.define('Rally.apps.teamboard.TeamBoardColumn', {
        extend: 'Rally.ui.cardboard.Column',
        alias: 'widget.rallyteamcolumn',
        requires: [
            'Rally.apps.teamboard.TeamBoardDropController',
            'Rally.apps.teamboard.plugin.TeamBoardUserIterationCapacity',
            'Rally.apps.teamboard.plugin.TeamBoardWip',
            'Rally.ui.cardboard.plugin.ColumnCardCounter',
            'Rally.ui.combobox.IterationComboBox'
        ],

        plugins: [
            {ptype: 'rallycolumncardcounter'},
            {ptype: 'rallyteamboardwip'},
            {ptype: 'rallyteamboarduseriterationcapacity'}
        ],

        config: {
            dropControllerConfig: {
                ptype: 'rallyteamboarddropcontroller'
            }
        },

        initComponent: function() {
            this.callParent(arguments);

            this.addEvents('iterationcomboready');
            this.on('storeload', this._addIterationCombo, this);
        },

        assign: function(record){
            // Don't need to do anything to the User record
        },

        getStoreFilter: function(model) {
            return {
                property: this.attribute,
                operator: 'contains',
                value: this.getValue()
            };
        },

        isMatchingRecord: function(record){
            return true;
        },

        _addIterationCombo: function() {
            this.getColumnHeader().add({
                xtype: 'container',
                cls: 'team-board-iteration-section',
                items: [{
                    xtype: 'rallyiterationcombobox',
                    allowNoEntry: true,
                    listeners: {
                        ready: this._onIterationComboReady,
                        scope: this
                    },
                    storeConfig: {
                        context: {
                            project: this.getValue(),
                            projectScopeDown: false,
                            projectScopeUp: false
                        }
                    }
                }]
            });
        },

        _onIterationComboReady: function(combo) {
            if (Rally.BrowserTest) {
                Rally.BrowserTest.publishComponentReady(this);
            }

            this.fireEvent('iterationcomboready', this, combo);
        }
    });

})();
                (function() {
    var Ext = window.Ext4 || window.Ext;

    Ext.define('Rally.apps.teamboard.TeamBoardProjectRecordsLoader', {
        requires: [
            'Rally.data.wsapi.Filter',
            'Rally.data.wsapi.Store'
        ],
        singleton: true,

        load: function(teamOids, callback, scope){
            var config = {
                model: Ext.identityFn('Project'),
                sorters: ['Name']
            };

            if(teamOids){
                config.filters = Rally.data.wsapi.Filter.or(Ext.Array.map(teamOids.toString().split(','), function(teamOid) {
                    return {
                        property: 'ObjectID',
                        operator: '=',
                        value: teamOid
                    };
                }));
            }else{
                config.pageSize = 25;
            }

            var store = Ext.create('Rally.data.wsapi.Store', config);
            store.load({
                callback: callback,
                scope: scope
            });
            return store;
        }
    });

})();
                (function() {
    var Ext = window.Ext4 || window.Ext;

    Ext.define('Rally.apps.teamboard.TeamBoardSettings', {
        requires: [
            'Rally.ui.picker.FieldPicker',
            'Rally.ui.picker.MultiObjectPicker'
        ],
        singleton: true,

        getFields: function(){
            return [this._getTeamsPickerConfig(), this._getFieldPickerConfig()];
        },

        _getTeamsPickerConfig: function(){
            return {
                xtype: 'rallymultiobjectpicker',
                alwaysExpanded: true,
                availableTextLabel: 'Available Teams',
                fieldLabel: 'Teams',
                pickerCfg: {
                    style: {
                        border: '1px solid #DDD',
                        'border-top': 'none'
                    },
                    height: 248,
                    shadow: false
                },
                margin: '10px 0 265px 0',
                maintainScrollPosition: true,
                modelType: 'Project',
                name: 'teamOids',
                pickerAlign: 'tl-bl',
                selectedTextLabel: 'Selected Teams',
                selectionKey: 'ObjectID',
                storeLoadOptions: {
                    params: {
                        order: 'Name ASC'
                    }
                },
                width: 300
            };
        },

        _getFieldPickerConfig: function(){
            var config = {
                xtype: 'rallyfieldpicker',
                fieldLabel: 'Card Fields',
                name: 'cardFields',
                modelTypes: ['User']
            };
            if(!Rally.environment.getContext().getPermissions().isWorkspaceOrSubscriptionAdmin()){
                config.fieldWhiteList = Rally.apps.teamboard.TeamBoardApp.ATTRIBUTES_VISIBLE_TO_WS_NON_ADMIN_USERS;
            }

            return config;
        }
    });

})();
                (function() {
    var Ext = window.Ext4 || window.Ext;

    Ext.define('Rally.apps.teamboard.TeamBoardApp', {
        extend: 'Rally.app.App',
        requires: [
            'Rally.apps.teamboard.TeamBoardCard',
            'Rally.apps.teamboard.TeamBoardColumn',
            'Rally.apps.teamboard.TeamBoardProjectRecordsLoader',
            'Rally.apps.teamboard.TeamBoardSettings',
            'Rally.apps.teamboard.TeamBoardUtil',
            'Rally.ui.cardboard.CardBoard',
            'Rally.ui.cardboard.plugin.Scrollable'
        ],

        statics: {
            ATTRIBUTES_VISIBLE_TO_WS_NON_ADMIN_USERS: ['ObjectID', 'EmailAddress', 'Phone', 'UserName', 'DisplayName', 'FirstName', 'MiddleName', 'LastName', 'Disabled', 'Role', 'Department', 'OfficeLocation', 'CostCenter', 'LoginName']
        },

        config: {
            defaultSettings: {
                cardFields: 'OfficeLocation,Phone'
            }
        },

        cls: 'team-board-app',
        settingsScope: 'workspace',

        launch: function() {
            Rally.apps.teamboard.TeamBoardProjectRecordsLoader.load(this.getSetting('teamOids'), this._onTeamsLoaded, this);
        },

        getSettingsFields: function() {
            return Rally.apps.teamboard.TeamBoardSettings.getFields();
        },

        _showNoDataMessage: function(msg){
            this.add({
                xtype: 'component',
                cls: 'no-data',
                html: '<p>' + msg + '</p>'
            });
        },

        _onTeamsLoaded: function(teams) {
            if (teams.length === 0) {
                this._showNoDataMessage('You do not have access to any of the teams chosen to be shown in this app');
                this._publishComponentReady();
                return;
            }

            this.add(this._getCardboardConfig(teams));
        },

        _getCardboardConfig: function(teams) {
            return {
                xtype: 'rallycardboard',
                attribute: 'TeamMemberships',
                cardConfig: {
                    xtype: 'rallyteamboardcard',
                    fields: this.getSetting('cardFields') ? Ext.Array.filter(this.getSetting('cardFields').split(','), function(field){
                        return Rally.environment.getContext().getPermissions().isWorkspaceOrSubscriptionAdmin() ||
                            Ext.Array.contains(this.self.ATTRIBUTES_VISIBLE_TO_WS_NON_ADMIN_USERS, field);
                    }, this) : []
                },
                context: this.getContext(),
                columns: Ext.Array.map(teams, function(team) {
                    return {
                        xtype: 'rallyteamcolumn',
                        columnHeaderConfig: {
                            xtype: 'rallycardboardcolumnheader',
                            headerTpl: Rally.apps.teamboard.TeamBoardUtil.linkToAdminPage(team, team.get('_refObjectName'), 'users')
                        },
                        value: team.get('_ref')
                    };
                }, this),
                listeners: {
                    load: this._onBoardLoad,
                    toggle: this._publishContentUpdated,
                    recordupdate: this._publishContentUpdatedNoDashboardLayout,
                    recordcreate: this._publishContentUpdatedNoDashboardLayout,
                    scope: this
                },
                plugins: [
                    {
                        ptype: 'rallyscrollablecardboard',
                        containerEl: this.getEl()
                    }
                ],
                readOnly: !Rally.environment.getContext().getPermissions().isWorkspaceOrSubscriptionAdmin(),
                storeConfig: {
                    filters: [
                        {
                            property: 'Disabled',
                            operator: '=',
                            value: 'false'
                        }
                    ],
                    sorters: [{
                        direction: 'ASC',
                        property: 'FirstName'
                    }]
                },
                types: ['User']
            };
        },

        _onBoardLoad: function(){
            this._publishContentUpdated();
            this._publishComponentReady();
        },

        _publishComponentReady: function() {
            if (Rally.BrowserTest) {
                Rally.BrowserTest.publishComponentReady(this);
            }
        },

        _publishContentUpdated: function() {
            this.fireEvent('contentupdated');
        },

        _publishContentUpdatedNoDashboardLayout: function() {
            this.fireEvent('contentupdated', {dashboardLayout: false});
        }
    });

})();

            Rally.launchApp('Rally.apps.teamboard.TeamBoardApp', {
                name:"Team Board",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .team-board-app .cardboard .column-container .column-header .team-board-iteration-section {
    border-top: 1px dotted #c6c6c6;
    padding: 5px;
}

.team-board-app .cardboard .column-container .column-header .team-board-iteration-section .wip-container {
    font-size: 14px;
    text-align: left;
}

.team-board-app .cardboard .column-container .column-header .wip-container .wip-item {
    margin-bottom: 2px;
    margin-top: 2px;
}

.team-board-app .rui-card .rui-card-content .card-header {
    margin-bottom: 3px;
    margin-left: 2px;
}

.team-board-app .rui-card .rui-card-content .card-header td {
    vertical-align: middle;
}

.team-board-app .rui-card .rui-card-content .card-header .card-header-spacer {
    width: 8px;
}

.team-board-app .rui-card .rui-card-content .card-header .card-header-user-info .team-member-name {
    font-family: NotoSansBold, Helvetica, Arial;
    font-size: 15px;
    font-weight: normal;
}

.team-board-app .rui-card .rui-card-right-side {
    padding-top: 5px;
    width: 70px;
}
    </style>
</head>
<body></body>
</html>
