<!DOCTYPE html>
<html>
<head>
    <title>Custom Board</title>

    <script type="text/javascript" src="/apps/x/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.board.Settings",{singleton:!0,requires:["Rally.ui.combobox.FieldComboBox","Rally.ui.combobox.ComboBox","Rally.ui.picker.FieldPicker","Rally.ui.TextField","Rally.ui.NumberField"],getFields:function(context){var alwaysSelectedValues=["FormattedID","Name","Owner","BlockedReason"];return[{name:"type",xtype:"rallycombobox",shouldRespondToScopeChange:!0,context:context,storeConfig:{model:Ext.identityFn("TypeDefinition"),sorters:[{property:"Name"}],fetch:["DisplayName","ElementName","TypePath"],filters:[{property:"Creatable",value:!0}],autoLoad:!1,remoteSort:!1,remoteFilter:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{select:function(combo,records){combo.fireEvent("typeselected",records[0].get("TypePath"),combo.context)},ready:function(combo){combo.store.sort("DisplayName"),Rally.data.ModelFactory.getModels({context:combo.context.getDataContext(),types:Ext.Array.map(combo.store.getRange(),function(record){return record.get("TypePath")}),success:function(models){combo.store.filterBy(function(record){return models[record.get("TypePath")].hasField("FormattedID")}),combo.fireEvent("typeselected",combo.getRecord().get("TypePath"),combo.context)}})}},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(context){this.refreshWithNewContext(context)}}},{name:"groupByField",fieldLabel:"Group By",xtype:"rallyfieldcombobox",readyEvent:"ready",handlesEvents:{typeselected:function(type,context){this.refreshWithNewModelType(type,context)}},listeners:{ready:function(combo){combo.store.filterBy(function(record){var attr=record.get("fieldDefinition").attributeDefinition;return attr&&!attr.ReadOnly&&attr.Constrained&&"COLLECTION"!==attr.AttributeType});var fields=Ext.Array.map(combo.store.getRange(),function(record){return record.get(combo.getValueField())});Ext.Array.contains(fields,combo.getValue())||combo.setValue(fields[0])}}},{name:"fields",fieldLabel:"Card Fields",xtype:"rallyfieldpicker",alwaysSelectedValues:alwaysSelectedValues,handlesEvents:{typeselected:function(type,context){this.refreshWithNewModelTypes([type],context)}}},{name:"order",xtype:"rallytextfield"},{type:"query"}]}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.board.BoardApp",{extend:"Rally.app.App",alias:"widget.boardapp",requires:["Rally.apps.board.Settings","Rally.ui.cardboard.CardBoard"],config:{defaultSettings:{type:"HierarchicalRequirement",groupByField:"ScheduleState",fields:"FormattedID,Name,Owner",query:"",order:"Rank"}},launch:function(){this.add({xtype:"rallycardboard",margin:"10px 0 0 0",types:[this.getSetting("type")],attribute:this.getSetting("groupByField"),context:this.getContext(),storeConfig:{filters:this._getQueryFilters()},cardConfig:{editable:!0,showIconMenus:!0,fields:this.getSetting("fields").split(",")},loadMask:!0})},getSettingsFields:function(){return Rally.apps.board.Settings.getFields(this.getContext())},onTimeboxScopeChange:function(){this.callParent(arguments),this.down("rallycardboard").refresh({storeConfig:{filters:this._getQueryFilters()}})},_getQueryFilters:function(){var queries=[];return this.getSetting("query")&&queries.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),this.getContext().getTimeboxScope()&&queries.push(this.getContext().getTimeboxScope().getQueryFilter()),queries}})})();

            Rally.launchApp('Rally.apps.board.BoardApp', {
                name:"Custom Board",
	            parentRepos:""
            });

        });
    </script>


</head>
<body></body>
</html>
